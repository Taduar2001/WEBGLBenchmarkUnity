<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Iframe + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Å–æ—á–∫–∞–º–∏</title>
  <style>
    body {
      margin: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
      background: linear-gradient(120deg, #ff9a9e 0%, #fad0c4 100%);
      height: 100vh;
      font-family: system-ui, sans-serif;
    }
    .transparent-iframe { width: 20%; height: 70%; border: none; background-color: transparent; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="text"] { padding: 8px 10px; width: 280px; border-radius: 8px; border: none; }
    button {
      padding: 10px 16px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer;
      background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.2s;
    }
    button:hover { transform: scale(1.03); }
    .hint { opacity: .85; font-size: 14px; }
  </style>
</head>
<body>
  <iframe id="game-frame"
          class="transparent-iframe"
          src="https://webgltestorg.github.io/TestAll2/"
          allowtransparency="true"></iframe>

  <div class="controls">
    <button id="randomBtn" disabled>üé≤ –°–ª—É—á–∞–π–Ω—ã–π –∫—É—Å–æ–∫</button>
    <input id="uniqIdInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ uniq_id (UUID)" />
    <button id="openBtn" disabled>üîé –û—Ç–∫—Ä—ã—Ç—å –ø–æ uniq_id</button>
    <button id="closeBtn" disabled>‚ùå –ó–∞–∫—Ä—ã—Ç—å –∫—É—Å–æ—á–µ–∫</button>
  </div>
  <div class="hint" id="hint">–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ iframe‚Ä¶</div>

  <script>
  const frame = document.getElementById('game-frame');
  // –≤—ã—á–∏—Å–ª—è–µ–º –û–†–ò–ì–ò–ù –∞–π—Ñ—Ä–µ–π–º–∞ –∏–∑ src ‚Äî –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏–º
  const FRAME_ORIGIN = new URL(frame.src, location.href).origin;

  const randomBtn   = document.getElementById('randomBtn');
  const openBtn     = document.getElementById('openBtn');
  const closeBtn    = document.getElementById('closeBtn');
  const uniqIdInput = document.getElementById('uniqIdInput');
  const hint        = document.getElementById('hint');

  let currentOpen = null;

  function post(type, payload) {
    frame.contentWindow?.postMessage({ type, payload }, FRAME_ORIGIN);
  }

  // –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ—ã –æ –∫—É—Å–æ—á–∫–µ
  function pieceToText(payload) {
    const p = payload?.piece || {};
    const id    = p.uniq_id || '‚Äî';
    const title = p.title || p.name || '';
    const fill  = (p.filling_id ?? '') + '';
    const ca    = p.created_at ? `, created_at=${p.created_at}` : '';
    const ms    = p.moderate_status ? `, status=${p.moderate_status}` : '';
    return `uniq_id=${id}${title ? `, title="${title}"` : ''}${fill ? `, filling_id=${fill}` : ''}${ca}${ms}`;
  }

  window.addEventListener('message', (e) => {
    // –¥–µ–±–∞–≥: —Å–º–æ—Ç—Ä–∏, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç
    console.log('[parent <- child RAW]', e.origin, e.data);

    // –ø—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–º–µ–Ω–Ω–æ –æ—Ç –∞–π—Ñ—Ä–µ–π–º–∞
    if (e.origin !== FRAME_ORIGIN) return;

    const { type, payload, action, timestamp } = e.data || {};

    // ‚ú® –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —è–≤–Ω—ã–π –ª–æ–≥
    console.log('[parent] TYPE=', type, 'PAYLOAD=', payload, 'ACTION=', action, 'TS=', timestamp);

    switch (type) {
      case 'IFRAME_READY':
        hint.textContent = 'Iframe –∂–∏–≤. –ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ‚Ä¶';
        post('QUERY_INFO');
        break;

      case 'INFO': {
        const n = payload?.piecesCount ?? 0;
        if (n > 0) {
          hint.textContent = `–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã: ${n} –∫—É—Å–æ—á–∫–æ–≤.`;
          randomBtn.disabled = false;
          openBtn.disabled = false;
        } else {
          hint.textContent = '–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç, –∂–¥—ë–º‚Ä¶';
          setTimeout(() => post('QUERY_INFO'), 800);
        }
        break;
      }

      case 'BUSY_STATE': {
        const busy = !!payload?.busy;
        randomBtn.disabled = busy;
        openBtn.disabled   = busy;
        break;
      }

      case 'OPENING': {
        currentOpen = payload || null;
        hint.textContent = `–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${pieceToText(payload)}`;
        break;
      }

      case 'OPENED': {
        currentOpen = payload || null;
        hint.textContent = `–û—Ç–∫—Ä—ã—Ç: ${pieceToText(payload)}`;
        closeBtn.disabled = false;
        break;
      }

      case 'CLOSED': {
        currentOpen = null;
        hint.textContent = '–ö—É—Å–æ—á–µ–∫ –∑–∞–∫—Ä—ã—Ç.';
        closeBtn.disabled = true;
        break;
      }

      case 'OPEN_FAILED': {
        currentOpen = null;
        hint.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è.';
        closeBtn.disabled = true;
        break;
      }

      case 'OPEN_RESULT': {
        setTimeout(() => post('QUERY_BUSY'), 200);
        break;
      }

      case 'CLOSE_RESULT': {
        if (!payload?.ok) console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å (–Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ?)');
        break;
      }

      // –Ω–æ–≤–æ–µ: —Å–æ–±—ã—Ç–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–≤—ã—Ö 4 —É—Ä–æ–≤–Ω–µ–π
      case 'TOP4_VISIBILITY': {
        console.log('[parent] TOP4_VISIBILITY:', action);
        break;
      }

      case 'tower.top4Visibility': {
        console.log('[parent] tower.top4Visibility:', action);
        break;
      }
    }
  });

  // –∫–Ω–æ–ø–∫–∏
  randomBtn.addEventListener('click', () => post('OPEN_RANDOM'));
  openBtn.addEventListener('click', () => {
    const id = uniqIdInput.value.trim();
    if (!id) { alert('–í–≤–µ–¥–∏—Ç–µ uniq_id'); return; }
    // –Ω–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
    post('OPEN_BY_UNIQ', { uniqId: id });
    // –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –≤–Ω—É—Ç—Ä–∏ iframe –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å:
    // post('OPEN_BY_USER', { userId: id });
  });
  closeBtn.addEventListener('click', () => post('CLOSE_ANY'));
  </script>
</body>
</html>
