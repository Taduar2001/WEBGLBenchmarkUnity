<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Iframe + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Å–æ—á–∫–∞–º–∏</title>
  <style>
    body {
      margin: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
      background: linear-gradient(120deg, #ff9a9e 0%, #fad0c4 100%);
      height: 100vh;
      font-family: system-ui, sans-serif;
    }
    .transparent-iframe { width: 20%; height: 70%; border: none; background-color: transparent; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="text"] { padding: 8px 10px; width: 280px; border-radius: 8px; border: none; }
    button {
      padding: 10px 16px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer;
      background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.2s;
    }
    button:hover { transform: scale(1.03); }
    .hint { opacity: .85; font-size: 14px; }
  </style>
</head>
<body>
  <iframe id="game-frame"
          class="transparent-iframe"
          src="https://webgltestorg.github.io/TestAll2/"
          allowtransparency="true"></iframe>

  <div class="controls">
    <button id="randomBtn" disabled>üé≤ –°–ª—É—á–∞–π–Ω—ã–π –∫—É—Å–æ–∫</button>
    <input id="userIdInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ user_id (UUID)" />
    <button id="openBtn" disabled>üîé –û—Ç–∫—Ä—ã—Ç—å –ø–æ user_id</button>
    <button id="closeBtn" disabled>‚ùå –ó–∞–∫—Ä—ã—Ç—å –∫—É—Å–æ—á–µ–∫</button>
  </div>
  <div class="hint" id="hint">–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ iframe‚Ä¶</div>

  <script>
    const frame = document.getElementById('game-frame');
    const TARGET_ORIGIN = 'https://webgltestorg.github.io'; // –¥–æ–º–µ–Ω –∏–≥—Ä—ã

    const randomBtn = document.getElementById('randomBtn');
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const userIdInput = document.getElementById('userIdInput');
    const hint = document.getElementById('hint');

    function post(type, payload) {
      frame.contentWindow?.postMessage({ type, payload }, TARGET_ORIGIN);
    }

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –æ—Ç –∏–≥—Ä—ã
    window.addEventListener('message', (e) => {
      if (e.origin !== TARGET_ORIGIN) return;
      const { type, payload } = e.data || {};

      switch (type) {
        case 'IFRAME_READY':
          hint.textContent = 'Iframe –∂–∏–≤. –ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ‚Ä¶';
          post('QUERY_INFO');
          break;
        case 'INFO':
          const n = payload?.piecesCount ?? 0;
          if (n > 0) {
            hint.textContent = `–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã: ${n} –∫—É—Å–æ—á–∫–æ–≤.`;
            randomBtn.disabled = false;
            openBtn.disabled = false;
          } else {
            hint.textContent = '–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç, –∂–¥—ë–º‚Ä¶';
            setTimeout(() => post('QUERY_INFO'), 1000);
          }
          break;
        case 'BUSY_STATE': {
          const busy = !!payload?.busy;
          randomBtn.disabled = busy;
          openBtn.disabled = busy;
          closeBtn.disabled = busy; // –∑–∞–∫—Ä—ã—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ –∑–∞–Ω—è—Ç–æ
          break;
        }
        case 'OPEN_RESULT':
          console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è:', payload);
          setTimeout(() => post('QUERY_BUSY'), 200);
          break;
        case 'OPENING':
          console.log('–ù–∞—á–∞–ª–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫—É—Å–æ—á–∫–∞:', payload);
          hint.textContent = `–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫—É—Å–æ—á–µ–∫ user_id=${payload?.piece?.user_id || '???'}`;
          break;
        case 'OPENED':
          console.log('–ö—É—Å–æ—á–µ–∫ –æ—Ç–∫—Ä—ã—Ç:', payload);
          hint.textContent = `–û—Ç–∫—Ä—ã—Ç –∫—É—Å–æ—á–µ–∫ user_id=${payload?.piece?.user_id || '???'}`;
          closeBtn.disabled = false;
          break;
        case 'CLOSED':
          console.log('–ö—É—Å–æ—á–µ–∫ –∑–∞–∫—Ä—ã—Ç:', payload);
          hint.textContent = '–ö—É—Å–æ—á–µ–∫ –∑–∞–∫—Ä—ã—Ç.';
          closeBtn.disabled = true;
          break;
      }
    });

    // –∫–Ω–æ–ø–∫–∏
    randomBtn.addEventListener('click', () => post('OPEN_RANDOM'));
    openBtn.addEventListener('click', () => {
      const id = userIdInput.value.trim();
      if (!id) {
        alert('–í–≤–µ–¥–∏—Ç–µ user_id');
        return;
      }
      post('OPEN_BY_USER', { userId: id });
    });
    closeBtn.addEventListener('click', () => post('CLOSE_ANY'));
  </script>
</body>
</html>
